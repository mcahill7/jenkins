version: 0.2

env:
  variables:
    CFN_TEMPLATES: |
      ecr
      service

phases:
  install:
    runtime-versions:
      ruby: 2.6
    commands:
      - echo 'Build' action Install phase - install testing dependencies
      - gem install bundler cfn-nag docker-api rake rspec aws-sdk serverspec
      - bundle install
      - timeout 15 sh -c "until docker info; do echo .; sleep 1; done" 

#  pre_build:
#    commands:
#      - echo Linting started on `date`
#      - |
#        for cfn_template in $CFN_TEMPLATES; do
#          echo "Scanning CloudFormation template $cfn_template"
#          cfn_nag_scan --input-path infrastructure/$cfn_template.yaml --blacklist-path blacklist
#        done

  build:
    commands:
      - rake docker:build
      - rake docker:tag
      - rake docker:push

artifacts:
  files:
    - '**/*'
type: zip
